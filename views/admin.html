{% extends "layout.html" %}

{% block pageTitle %}Admin: Add School{% endblock %}

{% block content %}
<div class="page">
  <h1>Add a New School</h1>

    <form method="GET" action="/admin">
      <label>Or edit and Existing School</label>
      <select name="school" required>
        {% for school in schools %}
          <option value="{{ school._id }}">{{ school.name }}, {{ school.city.name }}</option>
        {% endfor %}
      </select>
      <button type="submit">Load</button>
    </form>

    <form action="/admin" method="POST" id="admin-form">
      <div class="form-grid">

        <input type="hidden" name="id" value="{{ school._id }}">

        <div>
          <label for="name" >School Name</label>
          <input name="name" id="name" placeholder="School Name" required
                 value="{{ school.name if school else '' }}">
        </div>

        <div>
          <label for="google_maps" >Google Maps</label>
          <input name="google_maps" id="google_maps" placeholder="Google Maps URL"
                 value="{{ school.google_maps if school else '' }}">

        </div>

        <div>
          <label for="review_score" >Review Score</label>
          <input name="review_score" id="review_score" placeholder="Review Score" type="number" step="0.1" min="0" max="5" required
                 value="{{ school.review_score if school else '' }}">
        </div>

        <div>
          <label>City</label>
          <select name="city" required>
            {% for city in cities %}
            <option value="{{ city._id }}" {% if city._id|string == school.city %}selected{% endif %}>
              {{ city.name }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div>
        <label for="description" >Description</label>
        <textarea name="description" id="description" placeholder="Description" rows="10">{{ school.description }}</textarea>
      </div>

      <hr>

      <h3>Courses</h3>
      <div id="courses-list">

        {% for course in school.courses %}
          <div class='course-block'>
            <input name='courses[{{ loop.index0 }}][name]' value="{{ course.name }}" required>
            <textarea name='courses[{{ loop.index0 }}][description]' rows='3'>{{ course.description }} </textarea>
            <input name='courses[{{ loop.index0 }}][class_size]' value="{{ course.class_size }}">
            <input name='courses[{{ loop.index0 }}][schedule]' value="{{ course.schedule }}" >
            <input name='courses[{{ loop.index0 }}][important_info]' value="{{ course.important_info }}">
            <input name='courses[{{ loop.index0 }}][price_per_week]' value="{{ course.price_per_week }}"  type='number'>
            <textarea name='courses[{{ loop.index0 }}][other_details]' >{{ course.other_details.join(",") }}</textarea>
            <button type='button' onclick='this.parentElement.remove()'>Remove</button>
          </div>
        {% endfor %}
      </div>

      <button type="button" onclick="addCourse()">Add Course</button>
      <hr>

      <h3>Accommodation</h3>
      <div id="accommodation-list">
        {% for accommodation in school.accommodation %}
          {% set accIdx = loop.index0 %}
          <div class='accommodation-block' id='accommodation-block-{{ accIdx }}'>
            <input name='accommodation[{{ accIdx }}][name]' value="{{ accommodation.name}}" required>
            <textarea name='accommodation[{{ accIdx }}][description]' placeholder='Description' rows='3'>{{ accommodation.description}}</textarea>
            <input name='accommodation[{{ accIdx }}][price_per_week]' value="{{ accommodation.price_per_week}}" type='number'>
            <div class='options-list' id='options-list-{{ accIdx }}'>
              {% for option in accommodation.options %}
                <div class='option-block'>
                  <input name='accommodation[{{ accIdx }}][options][{{ loop.index0 }}][name]' value="{{ option.name}}" required>
                  <input name='accommodation[{{ accIdx }}][options][{{ loop.index0 }}][price_per_week]' value="{{ option.price_per_week}}" type='number'>
                  <label style='font-weight:normal;display:inline;'>Prechecked
                    <input name='accommodation[{{ accIdx }}][options][{{ loop.index0 }}][prechecked]' type='checkbox' value='true' {% if option.prechecked %}checked{% endif %}>
                  </label>
                  <button type='button' onclick='this.parentElement.remove()'>Remove Option</button>
                </div>
              {% endfor %}
            </div>
            <button type='button' onclick='addOption("{{ accIdx }}")'>Add Option</button>
            <button type='button' onclick='this.parentElement.remove()'>Remove Accommodation</button>
          </div>
        {% endfor %}

      </div>
        <button type="button" onclick="addAccommodation()">Add Accommodation</button>
      <hr>

      <h3>Extra Fees</h3>
      <div id="fees-list">
        {% for fee in school.extra_fees %}
          <div class='fee-block'>
            <input name='extra_fees[{{ loop.index0 }}][name]' value="{{ fee.name }}" required>
            <input name='extra_fees[{{ loop.index0 }}][amount]' value="{{ fee.amount }}" type='number' required>
            <button type='button' onclick='this.parentElement.remove()'>Remove</button>
          </div>
        {% endfor %}

      </div>
        <button type="button" onclick="addFee()">Add Extra Fee</button>
      <hr>
      <button type="submit">Submit</button>
    </form>


</div>
<script>
let courseIdx = document.getElementsByClassName("course-block").length
let accIdx = document.getElementsByClassName("accommodation-block").length
let feeIdx = document.getElementsByClassName("fee-block").length
function addCourse() {
  const html = `<div class='course-block'>
    <input name='courses[${courseIdx}][name]' placeholder='Course Name' required>
    <textarea name='courses[${courseIdx}][description]' placeholder='Description' rows='3'></textarea>
    <input name='courses[${courseIdx}][class_size]' placeholder='Class Size'>
    <input name='courses[${courseIdx}][schedule]' placeholder='Schedule'>
    <input name='courses[${courseIdx}][important_info]' placeholder='Important Info'>
    <input name='courses[${courseIdx}][price_per_week]' placeholder='Price/Week' type='number'>
    <textarea name='courses[${courseIdx}][other_details]' placeholder='Other Details (comma separated)'></textarea>
    <button type='button' onclick='this.parentElement.remove()'>Remove</button>
  </div>`;
  document.getElementById('courses-list').insertAdjacentHTML('beforeend', html);
  courseIdx++;
}
function addAccommodation() {
  const idx = accIdx;
  const html = `<div class='accommodation-block' id='accommodation-block-${idx}'>
    <input name='accommodation[${idx}][name]' placeholder='Accommodation Name' required>
    <textarea name='accommodation[${idx}][description]' placeholder='Description' rows='3'></textarea>
    <input name='accommodation[${idx}][price_per_week]' placeholder='Price/Week' type='number'>
    <div class='options-list' id='options-list-${idx}'></div>
    <button type='button' onclick='addOption(${idx})'>Add Option</button>
    <button type='button' onclick='this.parentElement.remove()'>Remove Accommodation</button>
  </div>`;
  document.getElementById('accommodation-list').insertAdjacentHTML('beforeend', html);
  accIdx++;
}
function addOption(accIdx) {
  const optionsList = document.getElementById(`options-list-${accIdx}`);
  if (!optionsList) return;
  const optionIdx = optionsList.children.length;
  const html = `<div class='option-block'>
    <input name='accommodation[${accIdx}][options][${optionIdx}][name]' placeholder='Option Name' required>
    <input name='accommodation[${accIdx}][options][${optionIdx}][price_per_week]' placeholder='Price/Week' type='number'>
    <label style='font-weight:normal;display:inline;'>Prechecked <input name='accommodation[${accIdx}][options][${optionIdx}][prechecked]' type='checkbox' value='true'></label>
    <button type='button' onclick='this.parentElement.remove()'>Remove Option</button>
  </div>`;
  optionsList.insertAdjacentHTML('beforeend', html);
}
function addFee() {
  const html = `<div class='fee-block'>
    <input name='extra_fees[${feeIdx}][name]' placeholder='Fee Name' required>
    <input name='extra_fees[${feeIdx}][amount]' placeholder='Amount' type='number' required>
    <button type='button' onclick='this.parentElement.remove()'>Remove</button>
  </div>`;
  document.getElementById('fees-list').insertAdjacentHTML('beforeend', html);
  feeIdx++;
}
</script>
<style>
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1em; }
.course-block, .accommodation-block, .fee-block { border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; }
.options-list { margin: 1em 0 1em 1em; padding-left: 1em; border-left: 2px solid #eee; }
.option-block { margin-bottom: 0.7em; background: #f3f3f3; padding: 0.7em; border-radius: 4px; }
</style>
{% endblock %}
